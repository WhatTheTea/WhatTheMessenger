@page "/chats"
@rendermode InteractiveServer
@attribute [Authorize]

@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.SignalR.Client
@using System.Net
@using WhatTheMessenger.Application.Interfaces
@using WhatTheMessenger.Application.Models
@using WhatTheMessenger.Application.Services
@using WhatTheMessenger.Core.Models
@using WhatTheMessenger.Infrastructure.DataAccess
@using WhatTheMessenger.Infrastructure.Hubs
@using WhatTheMessenger.Server.App.Components

@inject IAppDbContext DbContext
@inject NavigationManager Navigation
@inject ICurrentUserService CurrentUserService
@inject IChatService ChatService
@inject IHttpContextAccessor HttpContextAccessor

<PageTitle>Chats</PageTitle>

<AuthorizeView>
    <h3>
        Hello @context.User.Identity?.Name!
    </h3>

    @if (userChats == null)
    {
        <p>Loading your chats...</p>
    }
    else if (!userChats.Any())
    {
        <p class="alert alert-info">You don't have any chats yet.</p>
    }
    else
    {
        <div>

            @foreach (var chat in userChats)
            {
                <div class="row">
                    <ChatItem Chat="@chat" />
                </div>
            }
        </div>
    }

    <button @onclick="CreateChat">New</button>
</AuthorizeView>

@code {
    private List<Chat> userChats = [];
    private User currentUser = default!;
    private HubConnection? hub;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {

        if (firstRender)
        {
            currentUser = (await GetUserFromAuthAsync())!;

            if (currentUser is null)
            {
                Navigation.NavigateTo("auth/logout");
                return;
            }

            LoadChats(currentUser);
            hub = new HubConnectionBuilder()
               .WithUrl(Navigation.ToAbsoluteUri("/hubs/chat"), options => {
                   options.Headers.Add("Cookie", HttpContextAccessor.HttpContext?.Request?.Headers?.Cookie ?? string.Empty);
               })
               .Build();

            hub.On<ChatDto>("ChatCreated", HandleNewChat);
            await hub.StartAsync();
        }

        StateHasChanged();
    }

    private async Task HandleNewChat(ChatDto chatDto)
    {
        var chat = await DbContext.Chats.FindAsync(chatDto.ChatId);

        if (chat is not null)
        {
            userChats.Add(chat);
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task CreateChat()
    {
        await ChatService.CreateChatAsync(new() { Name = null, Participants = [currentUser.Id] });
        @* LoadChats(currentUser); *@

        @* StateHasChanged(); *@
    }

    private void LoadChats(User user)
    {
        userChats = currentUser!.Chats.ToList();
    }

    private async Task<User?> GetUserFromAuthAsync()
    {
        var userGuid = await CurrentUserService.GetUserId();
        return await DbContext.Users.FindAsync(userGuid);
    }
}