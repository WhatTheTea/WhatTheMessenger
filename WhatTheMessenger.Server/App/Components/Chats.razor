@rendermode InteractiveServer
@attribute [Authorize]
@implements IAsyncDisposable

@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.SignalR.Client
@using System.Net
@using Microsoft.EntityFrameworkCore
@using System.Reactive.Subjects
@using System.Reactive;
@using System.Reactive.Linq
@using WhatTheMessenger.Application.Interfaces
@using WhatTheMessenger.Application.Models
@using WhatTheMessenger.Application.Services
@using WhatTheMessenger.Core.Models
@using WhatTheMessenger.Infrastructure.DataAccess
@using WhatTheMessenger.Infrastructure.Hubs
@using WhatTheMessenger.Server.App.Components

@inject IAppDbContext DbContext
@inject NavigationManager Navigation
@inject ICurrentUserService CurrentUserService
@inject IChatService ChatService
@inject IUserService UserService
@inject HubConnection HubConnection

<AuthorizeView>
    @if (userChats == null)
    {
        <p>Loading your chats...</p>
    }
    else if (!userChats.Any())
    {
        <p class="alert alert-info">You don't have any chats yet.</p>
    }
    else
    {
        <div>

            @foreach (var chat in userChats)
            {
                <div class="m-1">
                    <ChatNavItem Chat="@chat" />
                </div>
            }
        </div>
    }

    <div class="nav-item">
        <button class="nav-link mx-1" @onclick="() => IsCreateChatVisible = !IsCreateChatVisible">
            <span class="bi-plus-square-fill-nav-menu"/>
            <div class="mx-1">
                New
            </div>
        </button>
    </div>

    <Dialog IsVisible="@IsCreateChatVisible" OnConfirm="CreateChat" OnClose="() => IsCreateChatVisible = !IsCreateChatVisible">
        <EditForm Model="@newChatModel" FormName="newChat" Context="newChat">
            <div>
                Chat name:
                <InputText @bind-Value="@newChatModel.Name"/>
            </div>
            <div>

            Add user:
            <input type="text" @oninput="e => participantQuerySubject.OnNext(e.Value?.ToString() ?? string.Empty)" placeholder="Search users..."/>
            @if (userSearchResult.Any())
            {
                <ul>
                    @foreach (var user in userSearchResult)
                    {
                        <li style="cursor: pointer;" @onclick="() => newChatModel.Participants.Add(user.Id)">@user.UserName</li>
                    }
                </ul>
            }
            </div>

            <div>
            Added users:
            <ul>
                @foreach (var userId in newChatModel.Participants)
                {
                    <li>@userId</li>
                }
            </ul>                
            </div>
        </EditForm>
    </Dialog>
</AuthorizeView>

@code {
    private List<Chat> userChats = [];
    private NewChatModel newChatModel = new() {Name = string.Empty, Participants = []};
    private User currentUser = default!;

    private Subject<string> participantQuerySubject = new();
    private User[] userSearchResult = [];
    private IDisposable? chatHandler;

    private bool IsCreateChatVisible
    {
        get => field;
        set
        {
            field = value;
            userSearchResult = [];
            StateHasChanged();
        }
    }

    public async ValueTask DisposeAsync()
    {
        chatHandler?.Dispose();
        participantQuerySubject.Dispose();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            currentUser = (await GetUserFromAuthAsync())!;

            if (currentUser is null)
            {
                Navigation.NavigateTo("auth/logout");
                return;
            }

            await LoadChats(currentUser);

            if (HubConnection.State is HubConnectionState.Disconnected)
                await HubConnection.StartAsync();

            chatHandler = HubConnection.On<ChatDto>("ChatCreated", HandleNewChat);
            
            participantQuerySubject.Throttle(TimeSpan.FromMilliseconds(350))
                .DistinctUntilChanged()
                .Where(q => q.Length >= 2)
                .SelectMany(q => UserService.FindUsersAsync(q))
                .ObserveOn(SynchronizationContext.Current!)
                .Subscribe(results =>
                {
                    userSearchResult = results;
                    StateHasChanged();
                });
        }

        StateHasChanged();
    }

    private async Task HandleNewChat(ChatDto chatDto)
    {
        var chat = await DbContext.Chats.FindAsync(chatDto.ChatId);

        if (chat is not null)
        {
            userChats.Add(chat);
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task CreateChat()
    {
        if (string.IsNullOrEmpty(newChatModel.Name))
            newChatModel.Name = null;
        newChatModel.Participants.Add(currentUser.Id);
        await ChatService.CreateChatAsync(newChatModel);
        IsCreateChatVisible = false;
    }

    private async Task LoadChats(User user)
    {
        userChats = (await ChatService.GetChatsAsync(user.Id)).ToList();
    }

    private async Task<User?> GetUserFromAuthAsync()
    {
        var userGuid = await CurrentUserService.GetUserId();
        return await DbContext.Users.FindAsync(userGuid);
    }
}